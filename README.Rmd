---
output: 
  github_document:
    html_preview: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  fig.align = "center",
  fig.show = "hold",
  fig.retina = 2,
  out.width = "70%",
  #dev = "svg",
  message = FALSE,
  warning = FALSE
)
devtools::load_all()
```

```{r include=FALSE}
# a workaround to include htmlwidgets in github_document output format.
# This just generates the github-flavored markdown (.md) and then github
# generates on-the-fly the html from it. Thus htmlwidgets wont's work
# out-of-the-box. This solution is based on 
# https://stackoverflow.com/questions/61253015/render-ggplotly-in-r-markdown-github-document
# 
# yet, it will not work in github. Locally it works fine, but up there in 
# github, the github flavored markdown spec disallows some html tags, including
# <iframe> and therefore it will just show the code and not actually render the
# content of the iframe target
# https://github.github.com/gfm/#disallowed-raw-html-extension-
# Then, just webshot the htmlwidgets and make them a static image
iframe_htmlwidget <- function(htmlwidget) {
  
  html_path <- knitr::fig_path("html") # get the path like knitr would do
  # TODO: should I ensure this is always a relative path?
  #       it seems it is, but can't find assurances
  
  htmlwidgets::saveWidget(
    widget = htmlwidget, 
    file = normalizePath(html_path), # full path, otherwise it'll complain
    selfcontained = TRUE
    # selfcontained = TRUE, but still the dependencies are copied to te figures
    # dir so you need to exclude them via .gitignore to avoid commiting jquery,
    # plotly, and all other libraries in version control
  )
  
  # If local preview, you want the iframe to point to an absolute path because
  # "when you render from within RStudio using the Knit button the preview HTML 
  # is written to a temporary directory and then automatically displayed by 
  # RStudio.". 
  # https://rmarkdown.rstudio.com/github_document_format.html#HTML_Preview
  # 
  # They handle the images well, but they are not aware of the 
  # iframe, and therefore, the saved htmlwidget will not be found.
  # To overcome this, and absolute path in your system will do. However, that
  # won't work when it's online, so before pushing this to github, you should
  # set html_preview = FALSE and this little function will leave the iframe
  # with a relative path
  iframe_src_path <- ifelse(
    test = isTRUE(rmarkdown::metadata$output$github_document$html_preview),
    yes = normalizePath(html_path),
    no = html_path
  )

  htmltools::tags$iframe(
    src = iframe_src_path,
    width = "70%",
    height = "600",
    scrolling = "no",
    seamless = "seamless",
    frameBorder = "0",
    style = "display: block; margin: auto;"
  )
  # TODO: consider also not including assets in the html file but rather cdn links
  # see for example this SO question for ideas
  # https://stackoverflow.com/questions/51213463/how-to-skip-writing-dependencies-in-htmlwidgetssavewidget
  # plot_html_widget$dependencies[[2]]$src$file <- NULL
  # plot_html_widget$dependencies[[2]]$src$href <- "https://code.jquery.com/"s
}

# I guess this is another viable approach
# https://github.com/ropensci/plotly/issues/1620
# Basically use output: html_document: keep_md: true

# Need this little function to use webshot2
# Although plain webshot would be more convenient as rmarkdown would handle 
# it automatically, webshot does not get along good with plotly
webshotme <- function(htmlwidget, ...) {
  png_path <- knitr::fig_path("png") # get the path like knitr would do
  html_path <- tempfile(fileext = ".html")
  htmlwidgets::saveWidget(htmlwidget, file = html_path, selfcontained = TRUE)
  webshot2::webshot(html_path, file = png_path, ...)
}
```


# wdiquickplots

<!-- badges: start -->
<!-- badges: end -->

The goal of `wdiquickplots` is to provide, well, quick plots for World
Development Indicators (WDI, ["the primary World Bank collection of
development indicators, compiled from officially recognized international
sources."](https://databank.worldbank.org/home.aspx)).  To get WDI data, this
package is powered by [`WDI`](http://vincentarelbundock.github.io/WDI/) package,
developed by Vincent Arel-Bundock.

## Installation

You can install it from this Github repo with:

```r
remotes::install_github("edalfon/wdiquickplots")
```

## Examples

Use case: hey I have to present this study I have been working on in my home
country to an audience where I currently live (studying abroad or whatever).
Thus, some background data on my home country is in order. A table would
certainly do, but it is boring. So let's put some plots in there.

```{r dist, fig.asp=870/550, fig.width=4.5, out.width="47%", dev="svg"}
library(wdiquickplots)
plot_dist_wdi_ind("NY.GDP.PCAP.PP.CD", p = 0)
```

There you go. That's the spirit of this package. One line of code and bang!, 
a relatively decent plot that you can put in your slides to convey a quick 
message.

Using this package goes as follows:

- Find the code of the indicator of interest. You can use `WDI::WDIsearch` for
  this, but I actually find it a bit more user-friendly to simply go to the
  [indicators page
  (https://data.worldbank.org/indicator)](https://data.worldbank.org/indicator)
  and get the code from there (it's in the URL).
- You pass the indicator code as the first argument of the different plotting 
  functions in this package.
- As second argument, you pass the countries you want to highlight.

And there you go. Below you can see examples, but in general, the plots
in this package quickly show:

- Where the highlighted countries stand in terms of the indicator of interest.
- How do they compare among highlighted countries, and against the rest of the 
  world, regions or income groups.
- What have been the changes in time.

You can read other details and description of features in the `pkgdown` site for 
this little package (I know, a `pkgdown` site may be overkill, but anyway).


# Distribution

A plot to quickly compare highlighted countries, among them, and with the 
rest of the world using either regions or income, to group countries.

```{r dist_gini, fig.asp=870/550, fig.width=4, out.width="47%", dev="svg"}
plot_dist_wdi_ind("NY.GDP.PCAP.PP.CD", facets = income, p = 0)
```


# Bar plot

Similar as the distribution plot, quickly shows where the highlighted countries
stand in comparison with the rest of the world (without using any country
groups). This one is interactive so you can explore a bit (e.g. zooming in and 
out or see the exact value of the indicator for each country as tooltip).

```{r eval=FALSE}
wdiquickplots::plot_bar_wdi_ind("NY.GDP.PCAP.PP.CD")
```

```{r barplot, echo=FALSE}
webshotme(wdiquickplots::plot_bar_wdi_ind("NY.GDP.PCAP.PP.CD"))
```

# Race bar plot

Takes the same approach as the bar plot above, but showing also how it changes 
over time (powered by `gganimate`).

```{r race, out.width="40%", fig.asp=550/350, fig.width=5, cache=FALSE}
wdiquickplots::plot_race_wdi_ind("NY.GDP.PCAP.PP.CD")
```


# Line plot

Well, a line plot including only data from the highlighted countries. It shows 
directly the first and last value for each country and labels the series 
directly (it is an interactive plot as well).

```{r eval=FALSE}
wdiquickplots::plot_time_wdi_ind("NY.GDP.PCAP.PP.CD")
```

```{r lineplot, echo=FALSE}
webshotme(wdiquickplots::plot_time_wdi_ind("NY.GDP.PCAP.PP.CD"))
```

# Facetted line plot

Also a line plot as above, but including data for all countries.
It is powered by `gghighlight` to disentangle the spaghetti plot.

```{r time_facets, dev="svg"}
wdiquickplots::plot_time_facets_wdi_ind("NY.GDP.PCAP.PP.CD")
```

# Spaghetti plot

No one should ever see or want to see a spaghetti plot with so many series. 
Yet, here's one. `r emo::ji("see_no_evil_monkey")`.

Just have fun playing with it. The interactivity (powered by `dygraphs`)
highlights one series at a time, and sometimes (very rarely, but sometimes), can 
make such a spaghetti plot useful to identify eye-catching patterns.


```{r eval=FALSE}
wdiquickplots::plot_spaghetti_wdi_ind("NY.GDP.PCAP.PP.CD")
```

```{r spaghetti, echo=FALSE}
webshotme(wdiquickplots::plot_spaghetti_wdi_ind("NY.GDP.PCAP.PP.CD"))
```

